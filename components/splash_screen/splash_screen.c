#include "splash_screen.h"
#include "ssd1306.h"
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "esp_log.h"


static const uint8_t ethereum_logo[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x01, 0x80, 0x00, 0x00, 0x01, 0xc0, 0x00,
    0x00, 0x03, 0xe0, 0x00, 0x00, 0x07, 0xe0, 0x00, 0x00, 0x07, 0xf0, 0x00, 0x00, 0x0f, 0xf0, 0x00,
    0x00, 0x0f, 0xf8, 0x00, 0x00, 0x1f, 0xfc, 0x00, 0x00, 0x3f, 0xfc, 0x00, 0x00, 0x3f, 0xfe, 0x00,
    0x00, 0x7f, 0xfe, 0x00, 0x00, 0x7f, 0xff, 0x00, 0x00, 0xff, 0xff, 0x00, 0x01, 0xff, 0xff, 0x80,
    0x01, 0xff, 0xff, 0xc0, 0x03, 0xff, 0xff, 0xc0, 0x03, 0xff, 0xff, 0xe0, 0x07, 0xff, 0xff, 0xe0,
    0x07, 0xff, 0xff, 0xf0, 0x0f, 0xff, 0xff, 0xf8, 0x1f, 0xff, 0xff, 0xf8, 0x1f, 0xff, 0xff, 0xfc,
    0x3f, 0xff, 0xff, 0xfc, 0x3f, 0xff, 0xff, 0xfc, 0x0f, 0xff, 0xff, 0xf8, 0x03, 0xff, 0xff, 0xe0,
    0x21, 0xff, 0xff, 0x80, 0x10, 0x7f, 0xff, 0x0c, 0x0c, 0x1f, 0xfc, 0x18, 0x0f, 0x0f, 0xf0, 0x70,
    0x07, 0x83, 0xe1, 0xe0, 0x03, 0xe0, 0x83, 0xe0, 0x01, 0xf8, 0x0f, 0xc0, 0x01, 0xfc, 0x3f, 0x80,
    0x00, 0xff, 0x7f, 0x00, 0x00, 0x7f, 0xff, 0x00, 0x00, 0x3f, 0xfe, 0x00, 0x00, 0x3f, 0xfc, 0x00,
    0x00, 0x1f, 0xfc, 0x00, 0x00, 0x0f, 0xf8, 0x00, 0x00, 0x0f, 0xf0, 0x00, 0x00, 0x07, 0xe0, 0x00,
    0x00, 0x03, 0xe0, 0x00, 0x00, 0x01, 0xc0, 0x00, 0x00, 0x01, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00,
    0x00, 0x00, 0x00, 0x00
};

static const char *TAG = "SplashScreen";

void draw_splash_progress(SSD1306_t *dev, int progress_percent) {
    ESP_LOGI(TAG, "Entering show_splash_screen %d", progress_percent);
    ssd1306_clear_screen(dev, false);
    ESP_LOGI(TAG, "Clear screen show_splash_screen %d", progress_percent);

    // Kiá»ƒm tra dev->buffer
    if (dev == NULL) {
        ESP_LOGE(TAG, "draw_splash_progress: dev is NULL");
        return;
    }

    int centerX = (ssd1306_get_width(dev) - 32) / 2;
    int centerY = (ssd1306_get_height(dev) - 48) / 2;

    // Draw logo
    ssd1306_bitmaps(dev, centerX, centerY, ethereum_logo, 32, 49, false);
    ESP_LOGI(TAG, "Draw bitmap");
    // Draw progress bar
    int barY = centerY + 49 + 5;
    int barWidth = 128;
    int fillWidth = (barWidth * progress_percent) / 100;

    // Draw empty progress bar
    for (int x = 0; x < barWidth; x++) {
        _ssd1306_pixel(dev, x, barY, true);
        _ssd1306_pixel(dev, x, barY + 5, true);
    }

    // Draw filled portion
    for (int x = 0; x < fillWidth; x++) {
        for (int y = 1; y < 5; y++) {
            _ssd1306_pixel(dev, x, barY + y, true);
        }
    }

    ESP_LOGI(TAG, "dev->_address = 0x%02X", dev->_address);
    ESP_LOGI(TAG, "SHOW BUFFER");
    ssd1306_show_buffer(dev);
    ESP_LOGI(TAG, "END SHOW BUFFER");
}

void show_splash_screen(SSD1306_t *dev, InitTask tasks[], int task_count) {
    ESP_LOGI(TAG, "Entering show_splash_screen ");
    draw_splash_progress(dev, 0);
    vTaskDelay(pdMS_TO_TICKS(500));

    for (int i = 0; i < task_count; ++i) {
        ESP_LOGI(TAG, "Entering task %d", i);
        tasks[i]();
        ESP_LOGI(TAG, "End task %d", i);
        int progress = ((i + 1) * 100) / task_count;
        draw_splash_progress(dev, progress);
        vTaskDelay(pdMS_TO_TICKS(200));
    }

    vTaskDelay(pdMS_TO_TICKS(500));
}
