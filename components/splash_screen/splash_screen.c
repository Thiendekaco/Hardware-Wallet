#include "splash_screen.h"
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"


static const uint8_t ethereum_logo[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x01, 0x80, 0x00, 0x00, 0x01, 0xc0, 0x00,
    0x00, 0x03, 0xe0, 0x00, 0x00, 0x07, 0xe0, 0x00, 0x00, 0x07, 0xf0, 0x00, 0x00, 0x0f, 0xf0, 0x00,
    0x00, 0x0f, 0xf8, 0x00, 0x00, 0x1f, 0xfc, 0x00, 0x00, 0x3f, 0xfc, 0x00, 0x00, 0x3f, 0xfe, 0x00,
    0x00, 0x7f, 0xfe, 0x00, 0x00, 0x7f, 0xff, 0x00, 0x00, 0xff, 0xff, 0x00, 0x01, 0xff, 0xff, 0x80,
    0x01, 0xff, 0xff, 0xc0, 0x03, 0xff, 0xff, 0xc0, 0x03, 0xff, 0xff, 0xe0, 0x07, 0xff, 0xff, 0xe0,
    0x07, 0xff, 0xff, 0xf0, 0x0f, 0xff, 0xff, 0xf8, 0x1f, 0xff, 0xff, 0xf8, 0x1f, 0xff, 0xff, 0xfc,
    0x3f, 0xff, 0xff, 0xfc, 0x3f, 0xff, 0xff, 0xfc, 0x0f, 0xff, 0xff, 0xf8, 0x03, 0xff, 0xff, 0xe0,
    0x21, 0xff, 0xff, 0x80, 0x10, 0x7f, 0xff, 0x0c, 0x0c, 0x1f, 0xfc, 0x18, 0x0f, 0x0f, 0xf0, 0x70,
    0x07, 0x83, 0xe1, 0xe0, 0x03, 0xe0, 0x83, 0xe0, 0x01, 0xf8, 0x0f, 0xc0, 0x01, 0xfc, 0x3f, 0x80,
    0x00, 0xff, 0x7f, 0x00, 0x00, 0x7f, 0xff, 0x00, 0x00, 0x3f, 0xfe, 0x00, 0x00, 0x3f, 0xfc, 0x00,
    0x00, 0x1f, 0xfc, 0x00, 0x00, 0x0f, 0xf8, 0x00, 0x00, 0x0f, 0xf0, 0x00, 0x00, 0x07, 0xe0, 0x00,
    0x00, 0x03, 0xe0, 0x00, 0x00, 0x01, 0xc0, 0x00, 0x00, 0x01, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00,
    0x00, 0x00, 0x00, 0x00
};

/**
 * @brief Draw the Ethereum logo and a progress bar using U8g2.
 */
void draw_splash_progress(u8g2_t *u8g2, int progress_percent) {
    u8g2_ClearBuffer(u8g2);

    int centerX = (u8g2_GetDisplayWidth(u8g2) - 32) / 2;
    int totalHeight = 49 + 5 + 6;
    int startY = (u8g2_GetDisplayHeight(u8g2) - totalHeight) / 2;

    // Draw logo
    u8g2_DrawXBMP(u8g2, centerX, startY, 32, 49, ethereum_logo);

    // Draw progress bar
    int barY = startY + 49 + 5;
    int barWidth = u8g2_GetDisplayWidth(u8g2);
    int barHeight = 6;

    u8g2_DrawFrame(u8g2, 0, barY, barWidth, barHeight);
    u8g2_DrawBox(u8g2, 1, barY + 1, (barWidth - 2) * progress_percent / 100, barHeight - 2);

    u8g2_SendBuffer(u8g2);
}

/**
 * @brief Show splash screen and sequentially run init tasks.
 */
void show_splash_screen(u8g2_t *u8g2, InitTask tasks[], int task_count) {
    draw_splash_progress(u8g2, 0);
    vTaskDelay(pdMS_TO_TICKS(500));

    for (int i = 0; i < task_count; ++i) {
        tasks[i]();
        int progress = ((i + 1) * 100) / task_count;
        draw_splash_progress(u8g2, progress);
        vTaskDelay(pdMS_TO_TICKS(200));
    }

    vTaskDelay(pdMS_TO_TICKS(500));
}